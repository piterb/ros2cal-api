name: Deploy

on:
  push:
    branches: ["main"]
    paths-ignore:
      - "infra/**"
      - ".github/workflows/infra.yml"
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  GCP_WIF_PROVIDER: ${{ vars.GCP_WIF_PROVIDER }}
  GCP_DEPLOY_SA_EMAIL: ${{ vars.GCP_DEPLOY_SA_EMAIL }}

  ARTIFACT_REPO: ${{ vars.ARTIFACT_REPO }}
  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE }}
  IMAGE_NAME: "app"

  # Non-secret env vars for Cloud Run
  CLOUD_RUN_ENV_VARS: |
    SPRING_PROFILES_ACTIVE=${{ vars.SPRING_PROFILES_ACTIVE }}
    SPRING_DATASOURCE_USERNAME=${{ vars.SPRING_DATASOURCE_USERNAME }}
    SPRING_DATASOURCE_URL=${{ vars.SPRING_DATASOURCE_URL }}

  # Secret names in Secret Manager (names only, not values)
  SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate required deploy vars
        run: |
          missing=()
          if [ -z "${ARTIFACT_REPO}" ]; then
            missing+=("ARTIFACT_REPO")
          fi
          if [ -z "${CLOUD_RUN_SERVICE}" ]; then
            missing+=("CLOUD_RUN_SERVICE")
          fi
          if [ -z "${GCP_DEPLOY_SA_EMAIL}" ]; then
            missing+=("GCP_DEPLOY_SA_EMAIL")
          fi
          if [ ${#missing[@]} -ne 0 ]; then
            echo "Missing required GitHub Environment variables: ${missing[*]}" >&2
            echo "Set them in the GitHub Environment before running build/deploy." >&2
            exit 1
          fi

      - name: Authenticate to Google Cloud (OIDC / WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_DEPLOY_SA_EMAIL }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: |
          gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        id: build
        run: |
          IMAGE_URI="${{ env.GCP_REGION }}-docker.pkg.dev/${{ env.GCP_PROJECT_ID }}/${{ env.ARTIFACT_REPO }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"
          docker build -t "$IMAGE_URI" .
          docker push "$IMAGE_URI"

    outputs:
      image_uri: ${{ steps.build.outputs.image_uri }}

  deploy:
    needs: build
    environment: prod
    runs-on: ubuntu-latest

    env:
      IMAGE_URI: ${{ needs.build.outputs.image_uri }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (OIDC / WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ env.GCP_WIF_PROVIDER }}
          service_account: ${{ env.GCP_DEPLOY_SA_EMAIL }}
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.CLOUD_RUN_SERVICE }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.IMAGE_URI }}
          env_vars: ${{ env.CLOUD_RUN_ENV_VARS }}
          secrets: |
            SPRING_DATASOURCE_PASSWORD=${{ env.SPRING_DATASOURCE_PASSWORD }}:latest

      - name: Dump service conditions on failure
        if: failure()
        run: |
          echo "Deploy failed; Cloud Run service conditions:" >&2
          gcloud run services describe "${CLOUD_RUN_SERVICE}" \
            --region "${GCP_REGION}" \
            --project "${GCP_PROJECT_ID}" \
            --format="table(status.conditions[type],status.conditions[status],status.conditions[reason],status.conditions[message])" || true

      - name: Show service URL
        run: |
          echo "Deployed to: ${{ steps.deploy.outputs.url }}"
